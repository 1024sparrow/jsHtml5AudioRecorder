/**
 * Object:  jsHtml5AudioRecorder
 * Version: master
 * Author:  Edouard Kombo
 * Twitter: @EdouardKombo
 * Github:  https://github.com/edouardkombo
 * Blog:    http://creativcoders.wordpress.com
 * Url:     https://github.com/edouardkombo/jsHtml5AudioRecorder
 * 
 * Dual licensed under the MIT and GPL licenses:
 * http://www.opensource.org/licenses/mit-license.php
 * http://www.gnu.org/licenses/gpl.html
 * 
 * Record live audio stream in html5 with echo cancellation, save it on server or download directly from browser
 */

var jsHtml5AudioRecorder=function(){};jsHtml5AudioRecorder.prototype={audioContext:"",Recorder:false,mediaPath:"",phpFile:"",fftSize:2048,initAudio:function(){if(!navigator.getUserMedia){navigator.getUserMedia=navigator.webkitGetUserMedia||navigator.mozGetUserMedia}try{this.audioContext=new AudioContext;console.log("Audio context set up.");console.log("navigator.getUserMedia "+(navigator.getUserMedia?"available.":"not present!"))}catch(e){alert("No web audio support in this browser!")}window.onload=this.onLoad()},onLoad:function(){navigator.getUserMedia({audio:true},this.startStream.bind(this),function(e){alert("No audio stream!");console.log(e)})},startStream:function(e){var t=this.audioContext.createGain();var n=this.audioContext.createMediaStreamSource(e);n.connect(t);var r=this.audioContext.createAnalyser();r.fftSize=this.fftSize;t.connect(r);this.Recorder=new Recorder(t);var i=this.audioContext.createGain();i.gain.value=0;i.connect(this.audioContext.destination)},startRecording:function(){this.Recorder&&this.Recorder.record();console.log("Recording audio...")},stopRecording:function(e){this.Recorder&&this.Recorder.stop();this.Recorder&&this.Recorder.exportWAV(function(t){console.log(t);if(e==="save"){this.save(t)}else if(e==="download"){this.download(t)}else{this.save(t)}}.bind(this));this.Recorder.clear();console.log("Stop Recording audio!")},save:function(e){var t="path="+this.mediaPath+"&format=.wav";var n=new XMLHttpRequest;n.onreadystatechange=function(){if(n.readyState===4&&n.status===200){console.log(n.response)}}.bind(this);n.open("post",this.phpFile+"?"+t,true);n.setRequestHeader("X-Requested-With","XMLHttpRequest");n.setRequestHeader("cache-Control","no-store, no-cache, must-revalidate");n.setRequestHeader("cache-Control","post-check=0, pre-check=0");n.setRequestHeader("cache-Control","max-age=0");n.setRequestHeader("Pragma","no-cache");n.setRequestHeader("X-File-Name",encodeURIComponent("1"));n.setRequestHeader("Content-Type","application/octet-stream");n.send(e)},download:function(e){var t=window.URL.createObjectURL(e);var n=document.createElement("a");var r=(new Date).toISOString();n.href=t;n.id=r;n.download=r+".wav";n.innerHTML=n.download;n.style.display="none";n.style.visibility="hidden";document.body.appendChild(n);document.getElementById(n.id).click();document.getElementById(n.id).remove()}}